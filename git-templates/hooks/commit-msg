#!/usr/bin/php
<?php

/**
 * @file
 * Runs the commit message against Git standards.
 */

// Initial values for some variables.
$exit_status = 0;

// Get the commit message.
$message = file_get_contents($argv[1]);

// Output colors.
$red = "\e[0;31m";
$yellow = "\e[0;33m";
$no_color = "\e[0m";

$line_num = 1;
foreach (preg_split('/\v/', $message, -1) as $line) {
  // Once we reach commented out lines auto generated by git then we are done.
  if (substr($line, 0, 1) == '#') {
    break;
  }

  // The first line.
  if ($line_num == 1) {
    // The subject should be 50 characters or less.
    // This is not required, just recommended.
    if (strlen($line) > 50) {
      echo "{$yellow}Warning:{$no_color} The commit subject should be 50 characters or less. Yours is " . strlen($line) . " characters.", "\n";
    }

    // The subject must begin with a capital letter.
    if (!ctype_upper(substr($line, 0, 1))) {
      echo "{$red}Error:{$no_color} The commit subject must start with a capital letter.", "\n";
      $exit_status = 1;
    }

    // The subject must not end in a period.
    if (substr($line, -1, 1) == '.') {
      echo "{$red}Error:{$no_color} The commit subject must not end with a period.", "\n";
      $exit_status = 1;
    }
  }

  // The second line (if it exists) must be blank.
  if ($line_num == 2 && !empty($line)) {
    echo "{$red}Error:{$no_color} The second line of the commit message must be blank.", "\n";
    $exit_status = 1;
  }

  // The third line: start of the body.
  if ($line_num == 3) {
    // The body must begin with a capital letter.
    if (!ctype_upper(substr($line, 0, 1))) {
      echo "{$red}Error:{$no_color} The commit body must start with a capital letter.", "\n";
      $exit_status = 1;
    }
  }

  // Every line must be 72 characters or less.
  if (strlen($line) > 72) {
    echo "{$red}Error:{$no_color} Every line of the commit message must be 72 characters or less. Line $line_num is " . strlen($line) . " characters.", "\n";
    $exit_status = 1;
  }

  $line_num++;
}

exit($exit_status);
